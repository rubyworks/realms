#!/usr/bin/env ratch

# generate changes from history

config = configuration['changes']

history_file = config['history']  || 'log/history.txt'
changes_file = config['changes']  || 'CHANGES'

name, version, *rest = *File.read("meta/ROLLRC").split(/\s+/)

main :changes do
  build changes_file
end

file changes_file => [ history_file ] do
  history = File.read(history_file)
  matches = /^==\s*#{version}(.*?)(\n==|\Z)/m.match(history)
  changes = matches[0]
  changes = changes.chomp('==').strip.sub(/^==\s+/, "#{name} ")
  File.open(changes_file, 'w'){ |f| f << changes }
end

