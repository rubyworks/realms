#!/usr/bin/env ratch

# generate changelogs

config = configuration['changelog']

changes_txt  = config['txtlog'] || 'log/changelog.txt'
changes_xml  = config['xmllog'] || 'doc/log/changelog.xml'

main :changelog do
  if dryrun?
    puts changelog_in_xml
  else
    build changes_txt
    build changes_xml
  end
end

file changes_txt do
  mkdir_p File.dirname(changes_txt)
  svn "log > #{changes_txt}"
  puts "#{changes_txt} updated."
end

file changes_xml do
  mkdir_p File.dirname(changes_xml)
  text = changelog_in_xml
  File.open(changes_xml,'w'){ |f| f << text }
  puts "#{changes_xml} updated."
end

def changelog_in_xml
  text = `svn log --xml`
  i = text.index("?>\n")
  text.insert(i+2, "\n" + '<?xml-stylesheet href="changelog.xsl" type="text/xsl" ?>')
  text
end

